import board
import neopixel
import board
import digitalio
import usb_hid
import math
import time
import random
from adafruit_hid.keyboard import Keyboard
from adafruit_hid.keyboard_layout_us import KeyboardLayoutUS
from adafruit_hid.keycode import Keycode


# Initialize the HID, Neopixels, and buttons
pixel_pin = board.GP14
keycode = KeyboardLayoutUS(Keyboard(usb_hid.devices))
num_pixels = 144
light = neopixel.NeoPixel(pixel_pin, num_pixels, brightness=1, auto_write=False)

# Define the GPIO pins connected to the buttons
button_pins = [board.GP0, board.GP1, board.GP2, board.GP3, board.GP4, board.GP5, board.GP6, board.GP7, board.GP8, board.GP9, board.GP10, board.GP11, board.GP12, board.GP13]

# Create an array to hold the button objects
buttons = []
previous_states = []

def no_buttons_pressed():
    for button in buttons:
        if not button.value:
            return False
    return True

# Initialize the button objects and configure them as inputs
for pin in button_pins:
    button = digitalio.DigitalInOut(pin)
    button.direction = digitalio.Direction.INPUT
    button.pull = digitalio.Pull.UP
    buttons.append(button)
    previous_states.append(button.value)
    
    
state = 0


number_of_buttons = 6
speed = 0.01 #(this is the speed of the countdown after a stimuli is presented). Higher is faster. 0.1 is slow. 
stimuli = random.randint(0, number_of_buttons) 
delay = random.randint(2000, 10000) # this the delay between stimuli.
print(stimuli, delay)
timer = 0





for i in range(144):
    light[i] = (0, 0, 0)
light.show()
    
#light[1] = (0, 255, 0)



#this is the idle animation. 
loopsize = 72
wormlength = 30
numofloops = 2
def warmup():
    global timer
    global buttons
    global state
    timer = timer+ 1
    cur = timer%loopsize
    for i in range(0,numofloops):
        multi = loopsize*i
        light[cur+multi] = (60, 20, 0)
        light[cur-wormlength+multi] = (0, 0, 0)
        if cur-wormlength < 0:
            light[cur+(loopsize-wormlength)+multi] = (0, 0, 0)
    light.show()

    for i in range(len(buttons)):
        current_state = buttons[i].value
        if current_state != previous_states[i]:
            if current_state == False:
                print("Button " + str(i) + " is pressed")
                state = 1
                for i in range(143):
                    light[i] = (0, 0, 0)
                light.show()
                timer = 0
                break
            else:
                print("Button " + str(i) + " is released")
            previous_states[i] = current_state
        time.sleep(0.005)
    
    
#this is the loading animation.
bright = 255
def loading():
    global timer
    global bright
    global state
    timer = timer+ 1
    if timer < 72:
        time.sleep(0.01)
        light[timer] = (0, bright, 0)
        light[143-timer] = (0, bright, 0)
        light.show()
    elif bright > 20:
        bright = bright*0.99
        for n in range (0,144):
            light[n] = (0, bright, 0)
        light.show()
    else:
        timer = 0 
        state = 2




def checkpins():
    global buttons
    global state
    global stimuli
    global timer
    for i in range(len(buttons)):
        current_state = buttons[i].value
        if current_state != previous_states[i]:
            if current_state == False:
                if i == stimuli:
                    print("CORRECT HIT" + str(i))
                    timer = 0 
                    state = 6
                    break
                else:
                    print("INCORRECT HIT" + str(i))
                    timer = 0 
                    state = 5
                    break
            previous_states[i] = current_state

def flash(color):
    global timer
    global bright
    global state
    timer = timer+ 1
    if timer < 72:
        time.sleep(0.01)
        light[timer] = (0, bright, 0)
        light[143-timer] = (0, bright, 0)
        light.show()
    elif bright > 20:
        bright = bright*0.99
        for n in range (0,144):
            light[n] = (0, bright, 0)
        light.show()
    else:
        timer = 0 
        state = 2

ringsize = 12
while True:
    if state == 0: #idle animation before any button is pressed
        warmup()
    elif state == 1: #a button is pressed. Start loading animation. 
        loading()
    elif state == 2: #select a random stimuli after a random time.   
        timer = timer+1
        if timer > delay:
            print(stimuli)
            #keycode.write(str(stimuli))
            timer = 0
            time.sleep(0.005)
            for i in range(143):
                light[i] = (0, 0, 0)
            start= stimuli*ringsize
            print(start, "START!")
            for i in range(ringsize):
                light[start+i] = (255, 100, 0)
            light.show()
            state = 3
            if not no_buttons_pressed():
                state = 5
    elif state == 3: #countdown (stimuli)
        timer = timer+speed
        roundy = math.floor(timer)
        off = (stimuli*ringsize)-roundy+ringsize
        print(off)
        light[off] = (0, 0, 0)
        light.show()
        checkpins()
        if roundy > ringsize:
            state = 4
    elif state == 4: #countdown has run out
        print("too slow!")
        break
        #keycode.write("s")
    elif state == 5: #wrong button
        print("wrong button!")
        break
    elif state == 6: #correct press
        print("Correct!")
        flash()
    elif state == 7: #correct press
        print("new thing")
        break
